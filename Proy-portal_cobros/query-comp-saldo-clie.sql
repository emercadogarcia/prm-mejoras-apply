/* Composicion de saldo de cleintes */
SELECT TIPO_C,FECHA_VENCIMIENTO,DOCUMENTO,FECHA_FACTURA,TIPO_TRANSACCION,CONCEPTO,P_IMPORTE,P_IMPORTE_DIV,DIVISA_ORIGEN,AGENTE,CODIGO_CUENTA,CARACTER_ASIENTO,TIPO_REMESA,D_TIPO_REMESA,NUMERO_REMESA,FECHA_REMESA,BANCO,CODIGO_SWIFT,BANCO_ASEGURADOR,CONTRATO,VALOR_CAMBIO,TIPO_REMESA_FINANCIACION,NUM_CHEQUE,NUMERO_REMESA_FINANCIACION,FECHA_REMESA_FINANCIACION,BANCO_REMESA_FINANCIACION,FECHA_VALOR,ESTADO,EMPRESA,FECHA_ASIENTO,DIARIO,NUMERO_ASIENTO_BORRADOR,NUMERO_LINEA_BORRADOR,IMPORTE,IMPORTE_ENDOSADO,IMPORTE_COBRADO,IMPORTE_SUSTITUIDO,IMPORTE_DIVISA,IMPORTE_COBRADO_DIVISA,IMPORTE_SUSTITUIDO_DIVISA,FECHA_VALOR_DIVISA,STATUS_REMESADO,STATUS_FINANCIADO,STATUS_IMPAGADO,STATUS_RETENIDO,STATUS_IMPRESION,STATUS_ACEPTADO,DOCUMENTO_VIVO,DOCUMENTO_AGRUPADO,STATUS_RECLAMACION,CODIGO_CLIENTE,DOMICILIACION_MANUAL,DOMICILIACION_IBAN,SERIE_JUSTIFICANTE,JUSTIFICANTE,IMPORTE_DIV_NO_ASEGURADO,VALOR_CAMBIO_NO_ASEG,IMPORTE_DIVISA_ASEGURADO,IMPORTE_PDTE_DIVISA,ORIGEN,UUID,FECHA_TIMBRADO,NUMERO_EXPEDIENTE,D_NUMERO_EXPEDIENTE,D_CARACTER_ASIENTO,D_BANCO,D_BANCO_ASEGURADOR,D_TIPO_REMESA_FINANCIACION,D_BANCO_REMESA_FINANCIACION,FACTORING,FACTOR 

FROM (SELECT  historico_cobros.* , (SELECT b.nombre FROM bancos b WHERE b.empresa = historico_cobros.empresa AND b.codigo_rapido = historico_cobros.banco) D_BANCO,(SELECT b.nombre FROM bancos b WHERE b.empresa = historico_cobros.empresa AND b.codigo_rapido = historico_cobros.banco_asegurador) D_BANCO_ASEGURADOR, (SELECT c.nombre FROM caracteres_asiento c WHERE c.codigo = historico_cobros.caracter_asiento AND c.empresa = historico_cobros.empresa) D_CARACTER_ASIENTO, (SELECT ec.descripcion FROM expedientes_cab ec WHERE ec.empresa = historico_cobros.empresa and ec.codigo = historico_cobros.numero_expediente) D_NUMERO_EXPEDIENTE,DECODE((SELECT hi.uuid FROM historico_impuestos hi WHERE hi.numero_asiento_borrador = historico_cobros.numero_asiento_borrador AND hi.fecha_asiento = historico_cobros.fecha_asiento AND hi.diario = historico_cobros.diario AND hi.empresa = historico_cobros.empresa AND hi.numero_linea_borrador = historico_cobros.numero_linea_borrador AND rownum = 1), NULL, NULL,(SELECT TO_CHAR(d.fecha_certificado, pkpantallas.get_nls_date_format() || ' HH24:MI:SS') FROM facturas_ventas_doc d WHERE d.uuid = (SELECT hi.uuid FROM historico_impuestos hi WHERE hi.numero_asiento_borrador = historico_cobros.numero_asiento_borrador AND hi.fecha_asiento = historico_cobros.fecha_asiento AND hi.diario = historico_cobros.diario AND hi.empresa = historico_cobros.empresa AND hi.numero_linea_borrador = historico_cobros.numero_linea_borrador AND rownum = 1))) FECHA_TIMBRADO,f_cobros_cambios (pkpantallas.get_variable_env_varchar2('CAMBIO_ACTUAL'), pkpantallas.get_variable_env_varchar2('CAMBIO_ASEGURADO'), pkpantallas.get_variable_env_varchar2('DIVISA_PRESENTACION'), pkpantallas.get_variable_env_varchar2('CODIGO_DIVISA_PRESENTACION'), pkpantallas.get_variable_env_number('CAMBIO_DIVISA_PRESEN'), pkpantallas.get_variable_env_date('FECHA_VALOR'), pkpantallas.get_variable_env_varchar2('DIVISA_EMPRESA'), pkpantallas.get_variable_env_number('DECIMALES_EMPRESA'), divisa_origen, importe_divisa, importe_cobrado_divisa,valor_cambio, documento_vivo, importe_div_no_asegurado, valor_cambio_no_aseg, importe_divisa_asegurado, importe_pdte_divisa, importe, importe_endosado, importe_sustituido, importe_cobrado, importe_sustituido_divisa) P_IMPORTE,v_importe_divisa P_IMPORTE_DIV, (SELECT hi.uuid FROM historico_impuestos hi WHERE hi.numero_asiento_borrador = historico_cobros.numero_asiento_borrador AND hi.fecha_asiento = historico_cobros.fecha_asiento AND hi.diario = historico_cobros.diario AND hi.empresa = historico_cobros.empresa AND hi.numero_linea_borrador = historico_cobros.numero_linea_borrador AND rownum = 1) UUID,DECODE(historico_cobros.numero_remesa_financiacion, NULL, NULL,(SELECT fn.codigo_banco FROM financiaciones fn WHERE historico_cobros.empresa = fn.empresa AND historico_cobros.numero_remesa_financiacion = fn.numero AND historico_cobros.fecha_remesa_financiacion = fn.fecha_remesa)) BANCO_REMESA_FINANCIACION,DECODE(historico_cobros.numero_remesa_financiacion, NULL, NULL,(SELECT b.nombre FROM bancos b WHERE b.empresa = historico_cobros.empresa AND b.codigo_rapido = (SELECT fn.codigo_banco FROM financiaciones fn WHERE fn.empresa = historico_cobros.empresa AND fn.numero = historico_cobros.numero_remesa_financiacion AND fn.fecha_remesa = historico_cobros.fecha_remesa_financiacion))) D_BANCO_REMESA_FINANCIACION,DECODE(historico_cobros.numero_remesa, NULL, NULL, (SELECT tr.descripcion FROM tipos_remesa tr WHERE tr.empresa = historico_cobros.empresa AND tr.codigo = (SELECT r.tipo_remesa FROM remesas r WHERE r.empresa = historico_cobros.empresa AND r.numero = historico_cobros.numero_remesa AND r.fecha_remesa = historico_cobros.fecha_remesa))) D_TIPO_REMESA,DECODE(historico_cobros.numero_remesa_financiacion, NULL, NULL, (SELECT trf.descripcion FROM tipos_remesa_financiacion trf WHERE trf.empresa = historico_cobros.empresa AND trf.codigo = (SELECT fn.tipo_remesa FROM financiaciones fn WHERE fn.empresa = historico_cobros.empresa AND fn.numero = historico_cobros.numero_remesa_financiacion AND fn.fecha_remesa = historico_cobros.fecha_remesa_financiacion))) D_TIPO_REMESA_FINANCIACION,DECODE(historico_cobros.numero_remesa, NULL, NULL, (SELECT r.tipo_remesa FROM remesas r WHERE r.empresa = historico_cobros.empresa AND r.numero = historico_cobros.numero_remesa AND r.fecha_remesa = historico_cobros.fecha_remesa)) TIPO_REMESA,DECODE(historico_cobros.numero_remesa_financiacion, NULL, NULL, (SELECT fn.tipo_remesa FROM financiaciones fn WHERE fn.empresa = historico_cobros.empresa AND fn.numero = historico_cobros.numero_remesa_financiacion AND fn.fecha_remesa = historico_cobros.fecha_remesa_financiacion)) TIPO_REMESA_FINANCIACION 
FROM (SELECT fecha_vencimiento, documento, fecha_factura, tipo_transaccion, numero_remesa, fecha_remesa, contrato, numero_remesa_financiacion, fecha_remesa_financiacion, codigo_swift, estado, empresa, fecha_asiento, diario, numero_asiento_borrador, numero_linea_borrador, codigo_cuenta, importe, importe_endosado, importe_cobrado, importe_sustituido, importe_divisa, importe_cobrado_divisa, importe_sustituido_divisa, fecha_valor_divisa, status_remesado, status_financiado, status_impagado, status_retenido, status_impresion, status_aceptado, documento_vivo, documento_agrupado, status_reclamacion, codigo_cliente, domiciliacion_manual, domiciliacion_iban, serie_justificante, justificante, concepto, divisa_origen, agente, caracter_asiento, importe_div_no_asegurado, valor_cambio, valor_cambio_no_aseg, importe_divisa_asegurado, importe_pdte_divisa, factoring, situacion_apunte, usuario, 'CO' tipo_c, 'HC' origen, endoso, status_contabilizado, banco_asegurador, banco, v_importe_divisa, fecha_valor, num_cheque, numero_expediente, factor FROM v_historico_cobros) historico_cobros)  historico_cobros 

WHERE historico_cobros.fecha_factura BETWEEN to_date('01-01-2025','DD-MM-YYYY') AND to_date('06-05-2025','DD-MM-YYYY') AND historico_cobros.caracter_asiento IN (SELECT b.codigo_centro FROM grupos_ccont a, centros_grupo_ccont b WHERE a.empresa = '004' AND b.empresa = a.empresa AND a.codigo = '0401' AND a.codigo = b.codigo_grupo) AND NVL(historico_cobros.status_impagado, 'N') IN ('N','S','D','P','A','F') AND (historico_cobros.status_remesado = 'N' OR historico_cobros.status_remesado IS NULL) AND historico_cobros.tipo_c = 'CO' AND historico_cobros.situacion_apunte = 'D' AND NVL(historico_cobros.factoring, 'N') IN ('N', DECODE('S', 'S', 'A', 'N'), DECODE('N', 'S', 'F', 'N')) AND historico_cobros.empresa = '004' and (CODIGO_CLIENTE='014676') 
order by FECHA_VENCIMIENTO,DIVISA_ORIGEN
/**************************************************************/
select *
FROM v_historico_cobros
where empresa ='004'
and CODIGO_CLIENTE='014676' 
WHERE historico_cobros.fecha_factura BETWEEN to_date('01-01-2025','DD-MM-YYYY') AND to_date('06-05-2025','DD-MM-YYYY') AND historico_cobros.caracter_asiento IN (SELECT b.codigo_centro FROM grupos_ccont a, centros_grupo_ccont b WHERE a.empresa = '004' AND b.empresa = a.empresa AND a.codigo = '0401' AND a.codigo = b.codigo_grupo) AND NVL(historico_cobros.status_impagado, 'N') IN ('N','S','D','P','A','F') AND (historico_cobros.status_remesado = 'N' OR historico_cobros.status_remesado IS NULL) AND historico_cobros.tipo_c = 'CO' AND historico_cobros.situacion_apunte = 'D' AND NVL(historico_cobros.factoring, 'N') IN ('N', DECODE('S', 'S', 'A', 'N'), DECODE('N', 'S', 'F', 'N')) AND historico_cobros.empresa = '004' and (CODIGO_CLIENTE='014676') 
order by FECHA_VENCIMIENTO,DIVISA_ORIGEN

